---
title: "tutorials-graphs"
author: "Nikos Pechlivanis"
date: "2024-08-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load `libraries`

```{r message=FALSE}
# install.packages("data.table")
library(data.table)
# install.packages("stringr")
library(stringr)

# install.packages(c("ggplot2", "ggrepel", "ggtext", "ggh4x"))
library(ggplot2)
library(ggrepel)
library(ggtext)
library(ggh4x)

library(shadowtext)

# install.packages("extrafont")
library(extrafont)

library(packcircles)
```

## Load input dataset

```{r loaddata, include = FALSE}

## THIS SECTION MIGHT THROUGH AN ERROR
## THERE IS A BUG UNFORTUNATELY WITH fread FUNCTION
## RUN ON CONSOLE IN THIS CASE

tutorials_url <- "https://raw.githubusercontent.com/galaxyproject/galaxy_codex/results/microgalaxy/tutorials.tsv"
tools_url <- "https://raw.githubusercontent.com/galaxyproject/galaxy_codex/results/microgalaxy/tools.tsv"

tutorials_dt <- tutorials_url |> fread()
tools_dt <- tools_url |> fread()
```

## Compute number of tools and number of microGalaxy tools per tutorial

```{r}

# 1 ------------------------

dt1 <- tutorials_dt$Tools |> 
    str_split("\\,") |>
    lapply(str_squish) |>
    lapply(function(q) data.table("Galaxy tool id" = q)) |>
    rbindlist(idcol = "Topic_id")

dt1$Topic = tutorials_dt[dt1$Topic_id]$Topic
dt1$Title = tutorials_dt[dt1$Topic_id]$Title

# 2 ------------------------------------

tmp <- tools_dt[, c("Galaxy wrapper id", "Galaxy tool ids"), with = FALSE] |> unique()
tmp <- tmp[which(`Galaxy tool ids` != "")]

tmp <- tmp |>
    tidyr::separate_rows("Galaxy tool ids", sep = ",") |>
    setDT()


# 3 ------------------

index = match(dt1$`Galaxy tool id`, tmp$`Galaxy tool ids`)

dt1$`Galaxy wrapper id (microGalaxy)` = tmp[index][[1]]

# 4 ----------------------------

tutorials_dt$`Total No. of tools` = tutorials_dt$Tools |>
    str_split("\\,") |>
    lapply(str_squish) |>
    lapply(length) |>
    unlist()

tutorials_dt$`No. of microGalaxy tools` = tutorials_dt$Tools |>
    str_split("\\,") |>
    lapply(str_squish) |>
    lapply(function(q) which(q %in% tmp$`Galaxy tool ids`) |> length() ) |>
    unlist()

tutorials_dt$`No. of other tools` = tutorials_dt$`Total No. of tools` - tutorials_dt$`No. of microGalaxy tools`

```

### Exclude unnecessary columns

```{r}
tutorials_dt$Topic = NULL

tutorials_dt$Link = NULL

tutorials_dt$`Servers with precise tool versions` = NULL
tutorials_dt$`Servers with tool but different versions` = NULL
```

## Tools coverage graph: Bar plot

```{r}
df <- tutorials_dt[, c(
    "Title", 
    "No. of microGalaxy tools",
    "No. of other tools"
), with = FALSE]

colnames(df) = c("Title", "microGalaxy related", "Other")

df <- df |> melt(id.vars = "Title", variable.factor = FALSE, value.factor = FALSE)

df[, by = Title, N := sum(value)]


df <- df[order(N, value)]

df$Title <- df$Title |> factor(levels = df$Title |> unique())

a <- df |>
    ggplot(aes(value, Title)) +
    geom_col(aes(fill = variable)) +
    
    scale_x_continuous(expand = c(0, 0), limits = c(0, 65),
                       sec.axis = dup_axis(name = NULL)) +
    
    scale_fill_manual(values = c("Other" = "#6A6599", "microGalaxy related" = "#B24745")) +
    
    theme_minimal(base_family = "Calibri") +
    theme(
        legend.position = c(.80, .5),
        legend.title = element_blank(),
        
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        
        panel.grid.major.x = element_line(linewidth = .45, color = "grey85", linetype = "dashed", lineend = "round"),
        panel.grid.minor.x = element_line(linewidth = .45, color = "grey85", linetype = "dotted", lineend = "round"),
        
        axis.line.y = element_line(linewidth = .45, color = "grey75"),
        axis.ticks.y = element_line(linewidth = .45, color = "grey75"),
        
        axis.text.y = element_text(face = "bold")
    ) +
    
    labs(x = "No. of tools", y = "Tutorial title")

```

## Tools coverage graph: Heatmap

```{r}
# df <- tutorials_dt[, c(
#     "Title", 
#     "EDAM operation"
# ), with = FALSE]
# 
# colnames(df) = c("Title", "Tools")
# 
# df2 = df$Tools |> 
#     str_split("\\,") |> 
#     lapply(function(x) data.table("tool_id" = x |> str_squish())) |>
#     rbindlist(idcol = "tutorial_id")
# 
# df2$tutorial_id = df[df2$tutorial_id]$Title
# 
# df2 <- df2[which(!(tool_id %in% c(
#     "", 
#     "__BUILD_LIST__", 
#     "__EXTRACT_DATASET__",
#     "__FILTER_EMPTY_DATASETS__",
#     "__FILTER_FAILED_DATASETS__",
#     "__FLATTEN__", 
#     "__MERGE_COLLECTION__", 
#     "__SORTLIST__",
#     "__UNZIP_COLLECTION__",
#     "__UNZIP_COLLECTION__" 
# )))] |> unique()
# 
# 
# df2 <- df2 |> unique()
# df2$value <- 1
# 
# 
# m <- df2 |> dcast(tutorial_id ~ tool_id, value.var = "value", fill = 0)
# m <- m[, -1] |> setDF(rownames = m$tutorial_id) |> as.matrix()
# 
# 
# mm_c <- t(m) |> dist(method = "euclidean") |> hclust(method = "ward.D2")
# mm_r <- m |> dist(method = "euclidean") |> hclust(method = "ward.D2")
# 
# df2$tutorial_id <- df2$tutorial_id |> factor(levels = mm_r$labels[mm_r$order |> rev()])
# df2$tool_id <- df2$tool_id |> factor(levels = mm_c$labels[mm_c$order |> rev()])
# 
# a1 <- df2 |>
#     ggplot(aes(tool_id, tutorial_id)) +
#     geom_tile(color = "grey96") +
#     
#     theme_minimal() +
#     
#     theme(
#         axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 6)
#     )
```


## EDAM ontology distribution: packcircles

```{r}

# ----------------------
d1 <- tutorials_dt[, c("Title", "EDAM topic"), with = FALSE] |>
    tidyr::separate_rows("EDAM topic", sep = ",") |>
    setDT()

d2 <- tutorials_dt[, c("Title", "EDAM operation"), with = FALSE] |>
    tidyr::separate_rows("EDAM operation", sep = ",") |>
    setDT()

# ---------------------

d1$`EDAM topic` = d1$`EDAM topic` |> str_squish()
d1$`EDAM topic` = ifelse(d1$`EDAM topic` == "", "No Topic", d1$`EDAM topic`)
    
d2$`EDAM operation` = d2$`EDAM operation` |> str_squish()
d2$`EDAM operation` = ifelse(d2$`EDAM operation` == "", "No Operation", d2$`EDAM operation`)

d1 = d1[, by = `EDAM topic`, .(N = Title |> unique() |> length())]
d2 = d2[, by = `EDAM operation`, .(N = Title |> unique() |> length())]

# ------------------------------

# Generate the layout. 
# sizetype can be area or radius, 
# following your preference on what to be proportional to value.

packing_d1 <- circleProgressiveLayout(d1$N, sizetype = 'area') |> circleLayoutVertices(npoints = 100) |> setDT()
packing_d2 <- circleProgressiveLayout(d2$N, sizetype = 'area') |> circleLayoutVertices(npoints = 100) |> setDT()

packing_d1$strip <- d1[packing_d1$id]$`EDAM topic`
packing_d2$strip <- d2[packing_d2$id]$`EDAM operation`

packing_d1$`No. of Tutorials` <- d1[packing_d1$id]$N
packing_d2$`No. of Tutorials` <- d2[packing_d2$id]$N

packing_d1$pack <- "EDAM topic"
packing_d2$pack <- "EDAM operation"

d <- rbind(packing_d1, packing_d2)

h <- d[which(`No. of Tutorials` > 2), by = .(pack, strip, `No. of Tutorials`), .(
    x = (max(x) + min(x)) / 2,
    y = (max(y) + min(y)) / 2
)]

h$strip <- h$strip |> str_wrap(width = 8)

b <- d |>
    ggplot(aes(x, y, group = id)) + 
    geom_polygon(aes(fill = `No. of Tutorials`), color = "grey20", linewidth = .25) +
    
    geom_shadowtext(
        data = h, aes(x, y, label = strip, size = `No. of Tutorials`),
        inherit.aes = FALSE, bg.color = "grey96", color = "grey20", bg.r = .065,
        family = "Calibri"
    ) +
    
    scale_fill_stepsn(
        colors = c("#00429d", "#3761ab", "#5681b9", "#73a2c6", "#93c4d2", "#b9e5dd", "#ffffe0") |> rev(),
        guide = guide_colorsteps(
            barwidth = unit(10, "lines"),
            barheight = unit(.5, "lines")
        )
    ) +
    
    scale_size_continuous(range = c(1.5, 5), guide = "none") +
    
    facet_wrap(vars(pack), nrow = 1) +
    theme_void(base_family = "Calibri") + 
    theme(
        legend.position = "bottom",
        legend.title.position = "top",
        
        strip.text = element_text(face = "bold")
    ) +
    coord_equal()

```

## Saving graphs

```{r}

dir.create("../results/tutorials", showWarnings = FALSE)

# dt --------------------------

writexl::write_xlsx(dt1, "../results/tutorials/microGalaxy-tools.xlsx")

# 1 ---------------

ggsave(
    plot = a, filename = "../results/tutorials/tools-coverage.png",
    width = 7, height = 8, units = "in", dpi = 600
)

ggsave(
    plot = a, filename = "../results/tutorials/tools-coverage.pdf",
    width = 7, height = 8, units = "in", device = cairo_pdf
)

# 2 ---------------

ggsave(
    plot = b, filename = "../results/tutorials/edam.png",
    width = 10, height = 8, units = "in", dpi = 600
)

ggsave(
    plot = b, filename = "../results/tutorials/edam.pdf",
    width = 10, height = 8, units = "in", device = cairo_pdf
)

```
